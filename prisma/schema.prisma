// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int       @id @default(autoincrement())
  username     String    @unique @db.VarChar(50)
  email        String    @unique @db.VarChar(100)
  passwordHash String    @map("password_hash") @db.VarChar(255)
  createdAt    DateTime  @default(now()) @map("created_at")
  
  strategies    Strategy[]
  backtests     Backtest[]
  liveTrades    LiveTrade[]
  brokerConfigs BrokerConfig[]

  @@map("users")
}

model Strategy {
  id          Int       @id @default(autoincrement())
  userId      Int      @map("user_id")
  name        String   @db.VarChar(255)
  description String?  @db.Text
  code        String   @db.Text
  params      Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  backtests Backtest[]
  liveTrades LiveTrade[]

  @@map("strategies")
}

model Backtest {
  id        Int       @id @default(autoincrement())
  userId    Int       @map("user_id")
  strategyId Int?     @map("strategy_id")
  name      String    @db.VarChar(255)
  dataFile  String?   @map("data_file") @db.VarChar(255)
  params    Json      @default("{}")
  results   Json?
  tradesCsv String?   @map("trades_csv") @db.Text
  createdAt DateTime  @default(now()) @map("created_at")
  
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  strategy Strategy? @relation(fields: [strategyId], references: [id], onDelete: SetNull)

  @@map("backtests")
}

model LiveTrade {
  id         Int       @id @default(autoincrement())
  userId     Int       @map("user_id")
  strategyId Int?      @map("strategy_id")
  symbol     String    @db.VarChar(50)
  side       String    @db.VarChar(10)
  size       Decimal   @db.Decimal(18, 8)
  price      Decimal   @db.Decimal(18, 8)
  status     String    @default("pending") @db.VarChar(20)
  brokerType String    @default("paper") @map("broker_type") @db.VarChar(50)
  createdAt  DateTime  @default(now()) @map("created_at")
  executedAt DateTime? @map("executed_at")
  
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  strategy Strategy? @relation(fields: [strategyId], references: [id], onDelete: SetNull)

  @@map("live_trades")
}

model BrokerConfig {
  id            Int      @id @default(autoincrement())
  userId        Int      @map("user_id")
  brokerType    String   @map("broker_type") @db.VarChar(50)
  encryptedConfig String @map("encrypted_config") @db.Text
  isActive      Boolean  @default(false) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("broker_configs")
}

